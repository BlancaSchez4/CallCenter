@{
    Layout = "";
    List<SoftvMVC.Controllers.EncuestaController.Detalle_pregunta> preguntas = (List<SoftvMVC.Controllers.EncuestaController.Detalle_pregunta>)ViewData["preguntas"];


}

<html>

<head>
    <script src="~/plugins/jQuery/jQuery-2.1.4.min.js"></script>
    <!-- Tell the browser to be responsive to screen width -->
    <!-- Bootstrap 3.3.5 -->
    <title>PreView | @ViewBag.NombreEncuesta</title>
    <link rel="stylesheet" href="~/bootstrap/css/bootstrap.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">

    <link rel="stylesheet" href="~/plugins/iCheck/square/blue.css">
    <link rel="stylesheet" href="~/plugins/iCheck/square/purple.css">
    <link href="~/plugins/iCheck/square/orange.css" rel="stylesheet" />



    <link href="~/dist/js/jquery.flexdatalist.css" rel="stylesheet" />
    <script src="~/dist/js/jquery.flexdatalist.js"></script>
</head>
<body>

    <div class="container">
        <div class="row">
            <p class="text-right" style="color:#00a9b2; font-size:16px;"><strong>@ViewBag.FechaCreacion</strong></p>
            <h1 class="text-left" style="color:#f60;"><strong>@ViewBag.NombreEncuesta</strong></h1>
        </div>  
    </div>

    <div class="page-title" style="background-color:#00a9b2; width:100%;">
        <div class="container">
            <h3 style="color:#fff;">
                @ViewBag.Descripcion
            </h3>
        </div>
    </div><br />
    <form id="encuestaForm" method="post" action="/Encuesta/DatosEncuesta">
         <div class="row">
            <div class="col-md-6 col-md-offset-1">
                <div class="form-group">
                    <h4><label class="col-md-2 control-label" for="cliente"style="color:#f60;">Cliente</label></h4>
                    <div class="col-md-9" style="padding-top:-25px;">
                        <input type="text" class="flexdatalist form-control" name="cliente" required/>
                    </div>
                </div>
            </div>
        </div><br />
        <div class="container">

            @foreach (var a in preguntas)
            {


                <h4 style="color:#f60;"><b>@a.Pregunta.Pregunta</b></h4>
                <input type="hidden" name="p(@a.Pregunta.IdPregunta)"  value="@(a.Pregunta.Pregunta)"/>

                if (a.Pregunta.IdTipoPregunta.Value == 1)
                {
                    <div style="padding-left:30px;">
                        <textarea class="form-control" name="@(a.Pregunta.IdPregunta)_@a.Pregunta.IdPregunta" required></textarea>
                    </div>
                }

                if (a.Pregunta.IdTipoPregunta.Value == 2)
                {
                    <div style="padding-left:30px;">
                        <div class="radio icheck">
                            <input type="radio" id="@a.Pregunta.IdPregunta s" name="@(a.Pregunta.IdPregunta)_@a.Pregunta.IdPregunta" value="1">
                            <label for="@a.Pregunta.IdPregunta s">Si</label>
                        </div>
                        <div class="radio icheck">
                            <input type="radio" id="@a.Pregunta.IdPregunta n" name="@(a.Pregunta.IdPregunta)_@a.Pregunta.IdPregunta" value="0">
                            <label for="@a.Pregunta.IdPregunta n">No</label>
                        </div>
                    </div>
                }
                if (a.Pregunta.IdTipoPregunta.Value == 3)
                {
                    foreach (var b in a.Respuestas)
                    {
                        <div style="padding-left:30px;">
                            <div class="checkbox icheck">
                                <input id="@b.Id_ResOpcMult" type="checkbox" name="@(a.Pregunta.IdPregunta)_@b.Id_ResOpcMult" value="@b.ResOpcMult">
                                <label for="@b.Id_ResOpcMult">@b.ResOpcMult</label>
                            </div>
                        </div>
                    }


                }

            }

        </div>
        <div class="row">
            <div class="col-md-6 col-md-offset-5">
                <div class="btn-group" role="group" aria-label="...">
                    <button type="button" class="btn btn-success btn-lg" onclick="enviarEncuesta()">Guardar Encuesta</button>
                    <button type="button" class="btn btn-danger btn-lg">Borrar Valores</button>
                </div>
            </div>
        </div>
    </form>
        
   
</body>
<script src="~/plugins/iCheck/icheck.min.js"></script>
<script>
    //$(function () {
    //    $('input').iCheck({
    //        checkboxClass: 'icheckbox_square-orange',
    //        radioClass: 'iradio_square-orange',
    //        increaseArea: '20%' // optional
    //    });
    //});

    $('.flexdatalist').flexdatalist({
        minLength: 1,
        
        url: '/Cliente/ListaClientes/',
        selectionRequired: true,
        valueProperty: 'CONTRATO',
        textProperty: '{NOMBRE},{CONTRATO}',
        visibleProperties: ["NOMBRE", "CONTRATO"],
        searchIn: "NOMBRE",
    });


    function enviarEncuesta() {
        var html = $('#encuestaForm');
        var datos = {};
        datos.cliente = new Array();
        datos.pregunta = new Array();
        datos.respuestas = new Array();
        var cliente = [];
        var datos_preguntas = [];
        var datos_respuestas = [];
        var data = $('#encuestaForm').serializeArray().reduce(function (obj, item,indice) {
            obj[item.name] = item.value;
            if (indice == "0") {
                var cliente_encuestado = {};
                cliente_encuestado.id_cliente = item.value;
                cliente.push(cliente_encuestado);
            } else {
                if (parseInt(item.name)) {
                    var respuestas = {};
                    respuestas.id_pregunta = parseInt(item.name.split('_')[0]);
                    respuestas.respuesta = item.value;
                    datos_respuestas.push(respuestas);
                } else {
                    var preguntas = {};
                    var getID = item.name.replace('p', '').replace('(', '').replace(')', '');
                    preguntas.id_pregunta = parseInt(getID);
                    preguntas.nombre = item.value;
                    datos_preguntas.push(preguntas);
                }
            }
            return obj;
        }, {});
        datos.cliente.id_cliente = cliente[0].id_cliente;
        for (var i = 0; i < datos_preguntas.length; i++) {
            var pregunta = {};
            pregunta.id_pregunta = datos_preguntas[i].id_pregunta;
            pregunta.nombre = datos_preguntas[i].nombre;
            datos.pregunta.push(pregunta);
            for (var j = 0; j < datos_respuestas.length; j++) { 
                if (datos_preguntas[i].id_pregunta == datos_respuestas[j].id_pregunta) {
                    var respuestas = {};
                    respuestas.id_pregunta = datos_respuestas[j].id_pregunta;
                    respuestas.respuesta = datos_respuestas[j].respuesta;
                    datos.respuestas.push(respuestas);
                }
            }
        }

       
        $.ajax({
            url: "/Encuesta/DatosEncuesta/",
            type: "POST",
            data: { 'encuesta': datos },
            success: function (data, textStatus, jqXHR) {
                console.log(data);
            },
            error: function (jqXHR, textStatus, errorThrown) {

            }
        });

        console.log(datos);
    }
</script>
</html>

